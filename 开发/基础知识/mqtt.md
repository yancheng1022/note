---
title: mqtt
date: 2022/10/17
categories:
  - coding
tags:
  - mqtt
  - 消息队列
  - 编程基础
---
# 1、简介

MQTT 可以简单看做一个网络协议，用于机器对机器的通信（与客户端到服务器的传输有点区别）。智能传感器、可穿戴设备和其他物联网（IoT）设备通常必须通过带宽有限的资源受限网络传输和接收数据。这些物联网设备使用 MQTT 进行数据传输，因为它易于实施，并且可以有效地传输物联网数据。MQTT 支持设备到云端和云端到设备之间的消息传递。

## 1.1、特点

1、使用的发布/订阅消息模式，它提供了一对多消息分发，以实现与应用程序的解耦。
2、对负载内容屏蔽的消息传输机制。
3、对传输消息有三种服务质量（QoS）：最多一次，这一级别会发生消息丢失或重复，消息发布依赖于底层TCP/IP网络
   至多一次，这一级别会确保消息到达，但消息可能会重复。
   只有一次，确保消息只有一次到达。在一些要求比较严格的计费系统中，可以使用此级别
4、数据传输和协议交换的最小化（协议头部只有2字节），以减少网络流量
5、通知机制，异常中断时通知传输双方


## 1.2、mqtt协议实现方式

1、实现MQTT协议需要：客户端和服务器端
2、MQTT协议中有三种身份：发布者（Publish）、代理（Broker）（服务器）、订阅者（Subscribe）。其中，消息的发布者和订阅者都是客户端，消息代理是服务器，消息发布者可以同时是订阅者。
3、MQTT传输的消息分为：主题（Topic）和负载（payload）两部分。Topic，可以理解为消息的类型，订阅者订阅（Subscribe）后，就会收到该主题的消息内容（payload）。payload，可以理解为消息的内容，是指订阅者具体要使用的内容

# 2、三种服务质量

## 2.1、QoS 0：最多分发一次
当 QoS 为 0 时，消息的分发依赖于底层网络的能力。发布者只会发布一次消息，接收者不会应答消息，发布者也不会储存和重发消息。消息在这个等级下具有最高的传输效率，但可能送达一次也可能根本没送达。

通常选择使用 QoS 0 传输一些高频且不那么重要的数据，比如传感器数据，周期性更新，即使遗漏几个周期的数据也可以接受

## 2.2、QoS 1：最少分发一次
当 QoS 为 1 时，可以保证消息至少送达一次。MQTT 通过简单的 ACK 机制来保证 QoS 1。发布者会发布消息，并等待接收者的 PUBACK 报文的应答，如果在规定的时间内没有收到 PUBACK 的应答，发布者会将消息的 DUP 置为 1 并重发消息。接收者接收到 QoS 为 1 的消息时应该回应 PUBACK 报文，接收者可能会多次接受同一个消息，无论 DUP 标志如何，接收者都会将收到的消息当作一个新的消息并发送 PUBACK 报文应答


> QoS1在协议层面上无法避免消息重复的情况，因此在我们的报文内容里面通常加上报文的唯一id，在应用层通过id去对消息去重是最常规的处理方法

## 2.3、QoS 2：只分发一次

当 QoS 为 2 时，发布者和订阅者通过两次会话来保证消息只被传递一次，这是最高等级的服务质量，消息丢失和重复都是不可接受的。使用这个服务质量等级会有额外的开销。

发布者发布 QoS 为 2 的消息之后，会将发布的消息储存起来并等待接收者回复 PUBREC 的消息，发送者收到 PUBREC 消息后，它就可以安全丢弃掉之前的发布消息，因为它已经知道接收者成功收到了消息。发布者会保存 PUBREC 消息并应答一个 PUBREL，等待接收者回复 PUBCOMP 消息，当发送者收到 PUBCOMP 消息之后会清空之前所保存的状态。

当接收者接收到一条 QoS 为 2 的 PUBLISH 消息时，他会处理此消息并返回一条 PUBREC 进行应答。当接收者收到 PUBREL 消息之后，它会丢弃掉所有已保存的状态，并回复 PUBCOMP。

无论在传输过程中何时出现丢包，发送端都负责重发上一条消息。不管发送端是 Publisher 还是 Broker，都是如此。因此，接收端也需要对每一条命令消息都进行应答。

![image.png](https://yancey-note-img.oss-cn-beijing.aliyuncs.com/202310171035585.png)


总的来说，QoS级别越高，消息传递的可靠性越高，但延迟和带宽占用也越高。在选择QoS级别时，需要根据应用场景的需求来进行权衡。

# 3、消息可靠（持久化）
MQTT还有一个持久会话的功能，对应的是Clean Session（清理会话）选项。当Clean Session = 0，以及QoS为1或着2的时候，加入接收端离线了也会在下次在线时收到断连期间的消息。此时的消息会暂存在我们的MQTT服务器端

# 4、mqtt负载均衡
