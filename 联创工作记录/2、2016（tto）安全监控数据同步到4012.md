

# 1、需求背景

  
2016 - 应急平台为矿端系统，产生的数据存在矿端数据库。4012 - 煤矿智能服务平台需要用到2016产生的基础数据、实时数据、分站数据、预警数据、报警数据等。所以需要将矿端产生的数据同步到云

## 1.1、需要同步的相关数据和表

![image.png](https://yancey-note-img.oss-cn-beijing.aliyuncs.com/20240412092455.png)

**2016相关表：**

基础数据：gas_base_info  
实时数据：gas_real  
分站数据：gas_station_info  
预警数据：gas_alarm_history  
报警数据：gas_alarm

**4012相关表：**

aq_gas_base_info  
aq_gas_real  
aq_gas_station_info  
aq_gas_early_alarm  
aq_gas_alarm


truncate table aq_gas_base_info;
truncate table aq_gas_real;
truncate table aq_gas_station_info;
truncate table aq_gas_early_alarm;
truncate table aq_gas_alarm;

datax官方文档：[https://github.com/alibaba/datax?tab=readme-ov-file](https://github.com/alibaba/datax?tab=readme-ov-file)

# 2、部署实施

## 2.1、下载datax、datax-web

```
# 创建文件夹，存放安装包
mkdir /home/lantrack/datax
# 解压
tar -zxvf datax.tar.gz
tar -zxvf datax-web-2.1.2.tar.gz
```

## 2.2、配置java

```shell
#解压jdk到指定目录
tar -zxvf jdk-8u161-linux-x64.tar.gz -C /usr/local/java/
# 配置jdk环境变量
vi /etc/profile
# 内容
export JAVA_HOME=/usr/local/java/jdk1.8.0_161
export PATH=$JAVA_HOME/bin:$PATH
export CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar
export CANAL_SERVER_HOME=/usr/local/canal/deployer
export PATH=$CANAL_SERVER_HOME/bin:$PATH
# 刷新
source /etc/profile
```



## 2.2、部署脚本和配置文件

将相关脚本和配置文件上传到服务器/data/datax目录下

![image.png](https://yancey-note-img.oss-cn-beijing.aliyuncs.com/20240412092510.png)

shell去掉windows换行：sed -i 's/\r$//' init.sh

乱码解决：CHCP 65001

## 2.3、修改配置，执行初始化

```
# 修改配置文件
vi /data/datax/conf/config.properties
# 初始化
./init.sh
```

![image.png](https://yancey-note-img.oss-cn-beijing.aliyuncs.com/20240412092525.png)

## 2.4、添加定时任务

```
# 添加定时任务
crontab -e
# 每两分钟执行一次同步任务
*/2 * * * * /bin/bash /data/datax/start.sh
```


## 2.5、部署进程

芦子沟：067000001
何家堡：067000002
吴家窑：066000002

安全监控数据同步4012-基础数据表  30 1/5 * ? * * *   aq_gas_base_info  
安全监控数据同步4012-报警数据表  31 1/5 * ? * * *   aq_gas_alarm
安全监控数据同步4012-预警数据表  32 1/5 * ? * * *   aq_gas_early_alarm  
安全监控数据同步4012-实时数据表  33 1/5 * ? * * *   aq_gas_real 
安全监控数据同步4012-分站数据表  34 1/5 * ? * * *   aq_gas_station_info  


sed -i "s/^M//" init.sh

be+l12cx/AqVhgo0h0Kg5A==


 




