
**项目结构：**

csms-api：数据推送（android、ios平台）消息类型（通知、自定义消息） 范围（别名、标签、地理位置等）

csms-etl：数仓
- etl-gas：瓦斯数据流程
- etl-person：人员数据流程
- etl-product：产量数据流程

csms-home：系统首页

csms-mobile：移动端信息（最新版本，下载地址等）

csms-person：人员模块

csms-video：工业视频模块

csms-sys：系统功能（用户登录，邮件，IM等功能）


# 1、数据读取解析流程

**瓦斯入口：定时任务MonitorTaskXml.test()，30秒执行一次：**
**人员入口：定时任务MonitorTask.test()，30秒执行一次：**
**产量入口：定时任务MonitorTask.test()，30秒执行一次：**

1、采集频率校验（AQCS、RYCS每天一次，AQMT、RYWZ、RYTJ 5分钟一次）
2、检查SFTP目录71（localsftp）,将该目录下的文件保存到应用服务器（uploadxml目录下），删除SFTP目录下文件
3、按文件类型做解析处理
- 数据入库
- 上报怀仁应急局（上传sfpt（sftp.monitor-dir）+ 缓存json到redis，具体展示是应急局功能），上报记录入库（report_record）
- 上报省煤监局（上传sftp（ftp.report-dir）+ 缓存json到redis，具体展示是应急局功能），上报记录入库（report_record）。
- 备份：【通用】upload/sj_temp 【应急局】无备份 【省局】上报成功 -> 备份到upload/backup下，上报失败 -> 备份到upload/sj_temp/ftp_err下
- 删除uploadxml目录下文件

temp  sj_temp  backup




以芦子沟为例：

| 索引  | 文件类型                        | 入库                                                                                                                                                                             | 备注                                |
| :-- | :-------------------------- | :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------- |
| 1   | AQFZ（安全分站）                  | gas_station_info                                                                                                                                                               |                                   |
| 2   | AQMC（模拟量传感器） 和 AQKC（开关量传感器） | gas_base_info                                                                                                                                                                  |                                   |
| 3   | AQSS（实时数据）                  | gas_real                                                                                                                                                                       | 同时同步数据至4012 TDengine (矿端hbase 68) |
| 4   | AQBJ（安全报警）和AQYC（系统异常）       | gas_alarm                                                                                                                                                                      |                                   |
| 5   | AQCS（系统初始化）                 | gas_aqcs                                                                                                                                                                       |                                   |
| 6   | AQKJ（空间数据）                  |                                                                                                                                                                                |                                   |
| 7   | AQDQ（断电地区）                  |                                                                                                                                                                                |                                   |
| 8   | AQGX（传感器关系）                 |                                                                                                                                                                                |                                   |
| 9   | AQKD（开关量变化）                 |                                                                                                                                                                                |                                   |
| 10  | AQLJ（累计量文件）                 |                                                                                                                                                                                |                                   |
| 11  | AQMT（模拟量统计）                 |                                                                                                                                                                                |                                   |
| 12  | AQMT（模拟量统计）                 |                                                                                                                                                                                |                                   |
| 13  | AQKY（馈电异常）                  |                                                                                                                                                                                |                                   |
| 14  | RYSS（人员实时）                  | person_vacancy 空岗<br>person_well_abnormal 出井异常<br>person_info_err 人员卡异常<br>person_overman_check 超员<br>person_sleep_post 睡岗<br>person_real 人员实时数据<br>person_well_record 人员出入井记录 | 实时数据入hbase库                       |
| 15  | RYRY（人员参数）                  | person_param 人员参数                                                                                                                                                              |                                   |
| 16  | RYTJ（人员途径）                  |                                                                                                                                                                                |                                   |
| 17  | RYCS（人员初始）                  |                                                                                                                                                                                |                                   |
| 18  | RYKJ（人员空间）                  |                                                                                                                                                                                |                                   |
| 19  | RYGJ（人员轨迹线）                 |                                                                                                                                                                                |                                   |
| 20  | RYBC（人员班次）                  |                                                                                                                                                                                |                                   |
| 21  | RYTD（特定人员应到地点）              |                                                                                                                                                                                |                                   |
| 22  | RYFZ（人员分站）                  | person_station_param 人员分站                                                                                                                                                      |                                   |

# 2、告警预警消息

| 索引  | 报警类型                              | 位置                                         | 触发频率      | 触发条件                                                                                      | 示例内容                                                                                                                                                                                          | 发送渠道           | 群   |
| :-- | :-------------------------------- | :----------------------------------------- | :-------- | ----------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------- | --- |
| 1   | 报警持续时间过长                          | AlarmTaskXml.exec()定时任务                    | 1次/5min   | alarm_end_date为1900-01-01（未上报结束时间） && <br>持续时间 >= 告警阈值（默认30分钟）&& <br>持续时间 <= 告警范围（默认12小时） | Alert:[后安矿][瓦斯][瓦斯报警持续时间过长] [040A13->000006号分站->开关量->馈电->报警->报警开始时刻---2024-04-24 11:53:20->报警信息---CZ\|2024-04-24 11:58:25\|admin\|异常\|锁线松动\|严格按照要求执行，加强监测监控] 当前时间---2024-04-25 08:05:01 请及时排查 | 钉钉             |     |
| 2   | 文件生成过快                            | QueueExcuteXml.colFreVerSub()              | 1次/30s    | 上次发送时间为空 \|\|<br>距离上次上报超过30min                                                            | Alert:<br>后安矿,系统初始化（AQCS）文件生成过快                                                                                                                                                               | 钉钉             |     |
| 3   | AQSS文件生成过快                        | QueueExcuteXml.handleColFreAQSS            | 1次/30s    | 读取到的xml数量 >= 5 && <br>(上次发送时间为空 \|\|<br>距离上次上报超过30min)                                    | Alert:<br>后安矿，AQSS文件生成过快                                                                                                                                                                      | 钉钉             |     |
| 4   | 数据采集异常                            | QueueExcuteXml.reportAQCS                  | 1次/30s    | AQCS上报失败                                                                                  | Alert:<br>后安矿，数据采集异常                                                                                                                                                                          | 钉钉             |     |
| 5   | 文件未上报                             | QueueExcuteXml.checkFrequency              | 1次/5min   | 从未上报过该文件                                                                                  | Alert:<br>后安矿，未上报，安全分站（AQFZ）文件                                                                                                                                                                | 钉钉             |     |
| 6   | 文件上报断传                            | QueueExcuteXml.checkFrequency              | 1次/5min   | 断传时间超过允许断传时间                                                                              | Alert:<br>后安矿，未上报，安全分站（AQFZ）文件，文件上传中断，已断传1小时1分1秒，上次上报时间为2024-04-25 08：05：01                                                                                                                   | 钉钉             |     |
| 7   | 人员出现空岗问题                          | PersonVacancyServiceImpl.saveVacanInfo     | 1次/30s    | notice_alarm_setting中状态为出井异常 <br>&&<br>（未提醒过 \|\|<br>到当前时间间隔 >= 提醒频率）                     | Alert:[柴沟][人员][人员未出井持续时间过长],[持续没有出井人数---2], 详情：刘燕峰(58505) 下井时长：57649入井时刻：2024-04-25 16:20:05；张忠禄(58515) 下井时长：55890入井时刻：2024-04-25 16:49:24 当前时间---2024-04-26 08:21:36 请及时排查                   | 钉钉<br>短信       |     |
| 8   | 疑似领导增减告警                          | PersonInfoServiceImpl.checkLeaderChange    | 1次/30s    | notice_alarm_setting中状态为疑似领导增减<br>&&<br>（未提醒过 \|\|<br>到当前时间间隔 >= 提醒频率）                    | Alert:[东坡矿][人员][疑似领导增减告警],[ 原人员减少：闫亮(03361) 领导疑似减少：03361 新人员增加：闫亮(05526) 领导疑似增加：05526] 当前时间---2024-04-25 18:27:45 请及时排查                                                                       | 钉钉<br>短信       |     |
| 9   | 人员卡异常报警                           | PersonInfoErrServiceImpl.saveErrPersonInfo | 1次/30s    | notice_alarm_setting中状态为人员卡异常<br>&&<br>（未提醒过 \|\|<br>到当前时间间隔 >= 提醒频率）                     | Alert:[东坡矿][人员][人员卡异常报警],[存在人员基础信息与实时信息不匹配问题] 当前时间---2024-04-26 09:55:04 请及时排查                                                                                                                | 钉钉<br>短信       |     |
| 10  | 文件解析（写入数据）失败/<br>文件上传省局（应急局）FTP失败 | QueueExcute.sendDingTalkByNoticeRate       | 1次/30s    | notice_alarm_setting中状态为文件解析失败等<br>&&<br>（未提醒过 \|\|<br>到当前时间间隔 >= 提醒频率）                   | Alert:[东坡矿][人员][人员系统异常],[文件名称：067000001AQYC20240324131641.xml][错误信息：解析人员实时文件失败] 请及时排查                                                                                                         | 钉钉<br>短信       |     |
| 11  | 人员文件解析异常统计                        | QueueExcute.parseCheckErrNotice            | 1次/30s    | notice_alarm_setting文件校验统计<br>&&<br>（未提醒过 \|\|<br>到当前时间间隔 >= 提醒频率）                        | Alert:[柴沟][人员][人员文件解析异常统计] ,[异常开始时间---2024-03-11 16:50:38, 区间范围内错误出现次数---52752, 今日出现总次数---26, 错误信息人员异常（RYYC）煤矿编码要求9个字符长度] 当前时间---2024-04-26 10:04:05 请及时排查                                    | 钉钉<br>短信       |     |
| 12  | 人员出现空文件问题                         | QueueExcute.emptyFileErrorNotice           | 1次/30s    | notice_alarm_setting空文件异常<br>&&<br>（未提醒过 \|\|<br>到当前时间间隔 >= 提醒频率）                         | Alert:[柴沟][人员][人员出现空文件问题] ,[人员位置（RYWZ）：067000001RYWZ20240324131641.xml] 当前时间---2024-04-26 10:04:05 请及时排查                                                                                      | 钉钉<br>微信<br>短信 |     |
| 16  | 人员超员告警持续未结束数量                     | AlarmTask.checkPersonOverMan               | 1次/5min   | notice_alarm_setting超员<br>&&<br>（未提醒过 \|\|<br>到当前时间间隔 >= 提醒频率）                            | Alert:[虎龙沟][人员][人员超员报警持续时间过长],[人员超员告警持续未结束数量---1] 当前时间---2024-04-26 10:10:10 请及时排查                                                                                                            | 钉钉<br>短信       |     |
| 17  | 人员呼叫告警持续未结束报警                     | AlarmTask.checkPersonCall                  | 1次/5min   | notice_alarm_setting超时<br>&&<br>（未提醒过 \|\|<br>到当前时间间隔 >= 提醒频率）                            | Alert:[吴家窑矿][人员][人员呼叫报警持续时间过长],[人员呼叫告警持续未结束数量---1] 当前时间---2024-04-26 10:50:10 请及时排查                                                                                                           | 钉钉<br>短信       |     |
| 18  | 人员系统初始基础信息文件每天上传一次                | ReportBaseInfoSjTask.exec                  | 每天0点0分50秒 | 未在备份目录中找到最近的人员系统初始基础信息RYCS文件 \|\|<br>上传人员系统初始基础信息RYCS文件到省局失败（程序报错）                        | Alert:[东坡矿][人员][人员系统初始基础信息文件每天上传一次],[报失败：xxxx]                                                                                                                                                | 钉钉             |     |
| 19  | 上报中断检查                            | ReportSjInterruptTask.sendSjDingTalk 定时任务  | 1次/30s    | notice_alarm_threshold中上报省局中断                                                             | Alert:[砂石][上报中断检查], [瓦斯上报应急局中断，最后上报时间：2024-04-26 11:10:02], 疑似原因：矿端数据文件生成问题 当前时间---2024-04-26 11:12:21 请及时排查                                                                                  | 微信<br>钉钉       |     |
| 20  | 人员出现空岗问题                          | PersonVacancyServiceImpl.saveVacanInfo     | 1次/30s    | notice_alarm_setting                                                                      | Alert:[吴家窑矿][人员][人员出现空岗问题],[空岗开始时间: 2024-04-25 14:10:00, 已结束，持续时长---19分0秒], 当前时间---2024-04-25 14:29:21 请及时排查                                                                                  | 短信<br>钉钉<br>微信 |     |








