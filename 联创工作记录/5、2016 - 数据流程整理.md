数据读取、解析、入库、备份、上报、同步移动云流程，整理文档

**项目结构：**

csms-api：数据推送（android、ios平台）消息类型（通知、自定义消息） 范围（别名、标签、地理位置等）

csms-etl：数仓
- etl-gas：瓦斯数据流程
- etl-person：人员数据流程
- etl-product：产量数据流程

csms-home：系统首页

csms-mobile：移动端信息（最新版本，下载地址等）

csms-person：人员模块

csms-video：工业视频模块

csms-sys：系统功能（用户登录，邮件，IM等功能）


# 1、数据读取流程

定时任务MonitorTaskXml.test()，30秒执行一次：

遍历SFTP监控目录locallsftp（upload/gas）
将文件保存在本地目录（uploadxml+日期），并删除监控目录下的文件
exec开始解析xml里的数据
处理AQFZ(安全分站)，判断上报省局还是应急管理局。如果上报，生成文件上报到应急局SFTP
处理AQMC（模拟量传感器） 和 AQKC（开关量传感器），执行CDDY（测点定义），上报省煤监和应急局
处理AQSS（实时数据），上报省煤监和应急局，写入hbase
处理AQBJ（安全报警）和AQYC（系统异常），存数据库gas_alarm,上报应急局和省局
处理AQCS（系统初始化），存数据库gas_aqcs，上报配置report_config
处理AQKJ（空间数据）、处理AQDQ（断电区域）、处理AQGX（传感器关系）、处理AQKD（开关量变化）、处理AQLJ（累计量文件）、处理AQMT（模拟量统计）、处理AQKY（馈电异常）


# 2、数据读取解析流程

入口：定时任务MonitorTaskXml.test()，30秒执行一次：

1、采集频率校验（AQCS、RYCS每天一次，AQMT、RYWZ、RYTJ 5分钟一次）
2、检查SFTP目录（localsftp）,将该目录下的文件保存到应用服务器（uploadxml目录下），删除SFTP目录下文件
3、按文件类型做解析处理


| 索引  | 文件类型       | 入库               |     |     |
| :-- | :--------- | :--------------- | :-- | --- |
| 1   | AQFZ（安全分站） | gas_station_info |     |     |
| 2   |            |                  |     |     |

# 3、告警预警消息

| 索引  | 报警类型     | 位置                                     | 触发频率    | 触发条件                                                                                      | 示例内容                                                                                                                                                                                          | 发送渠道 |
| :-- | :------- | :------------------------------------- | :------ | ----------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---- |
| 1   | 报警持续时间过长 | AlarmTaskXml.exec()                    | 1次/5min | alarm_end_date为1900-01-01（未上报结束时间） && <br>持续时间 >= 告警阈值（默认30分钟）&& <br>持续时间 <= 告警范围（默认12小时） | Alert:[后安矿][瓦斯][瓦斯报警持续时间过长] [040A13->000006号分站->开关量->馈电->报警->报警开始时刻---2024-04-24 11:53:20->报警信息---CZ\|2024-04-24 11:58:25\|admin\|异常\|锁线松动\|严格按照要求执行，加强监测监控] 当前时间---2024-04-25 08:05:01 请及时排查 | 钉钉   |
| 2   |          | MonitorTaskXml.test() checkReviseDup() | 1次/30s  |                                                                                           |                                                                                                                                                                                               |      |
| 3   | 文件生成过快   | QueueExcuteXml.colFreVerSub()          | 1次/30s  | 上次发送时间为空 \|\|<br>距离上次上报超过30min                                                            | Alert:<br>后安矿,系统初始化（AQCS）文件生成过快                                                                                                                                                               |      |



# 4、疑问

## 4.1、为什么只解析最新文件

if (pathAQFZList.size() > 0) {  
    log.error("tag-excute-01：解析AQFZ，读取到" + pathAQFZList.size() + "个AQFZ文件");  
    threadPool.execute(() -> {  
        // 获取最新的文件  
        String path = getLatestFile(pathAQFZList);  
        excuteAQFZ(path);  
    });  
}






