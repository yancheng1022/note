// 短信
TencentSmsUtil.SmsSingleSender(phone, TencentUtil.appId, TencentUtil.appkey, TencentUtil.remindTemplateId, TencentUtil.smsSign, params);

// 微信
weixinUserInfoService.pushAlarmInfoMsg(mineName, "领导带班空岗", new DateTime().toString(), detail + ", 请及时查看预警信息并处理");

// 钉钉
DingTalkUtil.sendDingTalk(personNoticeTypeEntity.getNoticeUrl(), msg, personNoticeTypeEntity.getNoticePhones().split(","));

超限
中断  是否区分人员和瓦斯
空岗
数据核查
020107

| 序号  | 模块  | 菜单名称                        | 位置                                               | 完成情况 |
| :-- | :-- | :-------------------------- | ------------------------------------------------ | ---- |
| 1   | 安全  | 超限                          | GasAlarmConfigServiceImpl.gasAlarmCheckAndNotice | 完成   |
| 2   | 人员  | 空岗                          | PersonVacancyServiceImpl.saveVacanInfo           | 完成   |
| 3   | 安全  | 中断                          | ReportYjInterruptTask.sendYjSms                  | 完成   |
| 4   | 人员  | 中断                          | ReportYjInterruptTask.sendYjSms                  |      |
| 5   | 安全  | 报警文件中不存在实时数据                |                                                  |      |
| 6   | 安全  | 报警文件未上传报警结束时间               |                                                  |      |
| 7   | 安全  | 数据上传种类是否齐全                  |                                                  |      |
| 8   | 安全  | 信息不全：无传感器地点名称               |                                                  |      |
| 9   | 安全  | 信息不全：无报警门限值                 |                                                  |      |
| 10  | 安全  | 信息不全：无传感器类型                 |                                                  |      |
| 11  | 安全  | 信息不全：传感器命名相同或为其它或为空，或为模糊性地点 |                                                  |      |
| 12  | 人员  | 领导信息上传错误导致带班空岗              |                                                  |      |
| 13  | 人员  | 数据上传种类是否齐全                  |                                                  |      |
| 14  | 人员  | 是否存在超员                      |                                                  |      |
| 15  | 人员  | 是否存在疑似睡岗                    |                                                  |      |


```java
// 灵活预警 - 超限  
NoticeAlarmSettingEntity customerSmsNoticeEntity = noticeAlarmSettingService.getOne(new QueryWrapper<NoticeAlarmSettingEntity>().eq("module_name", "AQ").eq("scene_type", "100").eq("notice_state", "1"));  
Date lastCustomerSmsDate = DateUtil.parseDate(customerSmsNoticeEntity.getNoticeLastTime());  
if (Objects.nonNull(customerSmsNoticeEntity) && "1".equals(smsNoticeEntity.getNoticeState()) &&  
        sendNoticeBool(lastCustomerSmsDate, now, customerSmsNoticeEntity.getNoticeRate())) {  
    //短信提醒  
    String[] params = {mineName, "【传感器阈值超限】", DateUtil.getDateTime(), message};  
    String[] customerNoticePersons = StringUtils.isNotEmpty(customerSmsNoticeEntity.getNoticePhones()) ? customerSmsNoticeEntity.getNoticePhones().split(",") : new String[0];  
    for (String phone : customerNoticePersons){  
        Boolean flag = TencentSmsUtil.SmsSingleSenderWithResult(phone, TencentUtil.appId, TencentUtil.appkey, TencentUtil.remindTemplateId, TencentUtil.smsSign, params);  
        // 发送记录保存到记录表中  
        NoticeAlarmRecordEntity noticeAlarmRecordEntity = new NoticeAlarmRecordEntity();  
        noticeAlarmRecordEntity.setModuleName(customerSmsNoticeEntity.getModuleName());  
        noticeAlarmRecordEntity.setSceneType(customerSmsNoticeEntity.getSceneType());  
        noticeAlarmRecordEntity.setSceneName(customerSmsNoticeEntity.getSceneName());  
        noticeAlarmRecordEntity.setPhone(phone);  
        noticeAlarmRecordEntity.setSendTime(new Date());  
        noticeAlarmRecordEntity.setContent(message);  
        noticeAlarmRecordEntity.setSendResult(flag ? 1:0);  
        noticeAlarmRecordService.save(noticeAlarmRecordEntity);  
    }  
    //短信发送后更新发送时间  
    customerSmsNoticeEntity.setNoticeLastTime(cn.hutool.core.date.DateUtil.now());  
    noticeAlarmSettingService.saveOrUpdate(customerSmsNoticeEntity);  
}
```



# 2、sql备份

```sql
-- 消息记录表
CREATE TABLE `notice_alarm_record` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `module_name` varchar(8) DEFAULT NULL COMMENT '模块名称（RY、AQ）',
  `scene_type` varchar(8) DEFAULT NULL COMMENT '场景类型',
  `scene_name` varchar(100) DEFAULT NULL COMMENT '场景名称',
  `send_time` datetime DEFAULT NULL COMMENT '发送时间',
  `phone` varchar(20) DEFAULT NULL COMMENT '手机号',
  `send_result` tinyint(1) DEFAULT NULL COMMENT '发送结果（0-失败，1-成功）',
  `content` varchar(255) DEFAULT NULL COMMENT '短信内容',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

-- 通知类型（客户|内部）
ALTER TABLE notice_alarm_setting
ADD notice_type VARCHAR(8) 
comment '通知类型（0-内部，1-客户）' AFTER type;

-- 初始化历史数据（内部）通知类型
update notice_alarm_setting set notice_type = '0'

-- 灵活预警 - 超限
INSERT INTO `test`.`notice_alarm_setting` (`module_name`, `type`, `notice_type`, `notice_url`, `notice_phones`, `notice_state`, `notice_end_state`, `notice_middle_state`, `scene_type`, `scene_name`, `notice_rate`, `notice_unit`, `notice_last_time`) VALUES ( 'AQ', '1', '1', 'https://yun.tim.qq.com/v5/tlssmssvr/sendsms', NULL, '1', '0', '0', '100', '超限', '10', '分钟', NULL);

-- 报警文件中不存在实时数据
INSERT INTO notice_alarm_setting (`module_name`, `type`, `notice_url`, `notice_phones`, `customer_notice_phones`, `notice_state`, `customer_notice_state`, `notice_end_state`, `notice_middle_state`, `scene_type`, `scene_name`, `notice_rate`, `notice_unit`, `notice_last_time`) VALUES ('AQ', '1', 'https://yun.tim.qq.com/v5/tlssmssvr/sendsms', NULL, NULL, '0', '0', '0', '0', '20', '报警文件中不存在实时数据', '30', '分钟', NULL);

-- 报警文件未上传报警结束时间
INSERT INTO notice_alarm_setting (`module_name`, `type`, `notice_url`, `notice_phones`, `customer_notice_phones`, `notice_state`, `customer_notice_state`, `notice_end_state`, `notice_middle_state`, `scene_type`, `scene_name`, `notice_rate`, `notice_unit`, `notice_last_time`) VALUES ('AQ', '1', 'https://yun.tim.qq.com/v5/tlssmssvr/sendsms', NULL, NULL, '0', '0', '0', '0', '21', '报警文件未上传报警结束时间', '30', '分钟', NULL);

-- 数据上传种类不齐全
INSERT INTO notice_alarm_setting (`module_name`, `type`, `notice_url`, `notice_phones`, `customer_notice_phones`, `notice_state`, `customer_notice_state`, `notice_end_state`, `notice_middle_state`, `scene_type`, `scene_name`, `notice_rate`, `notice_unit`, `notice_last_time`) VALUES ('AQ', '1', 'https://yun.tim.qq.com/v5/tlssmssvr/sendsms', NULL, NULL, '0', '0', '0', '0', '22', '数据上传种类不齐全', '30', '分钟', NULL);

```



