---
title: mqtt
date: 2022/10/17
categories:
  - coding
tags:
  - mqtt
  - 消息队列
  - 编程基础
---
# 1、简介

MQTT 可以简单看做一个网络协议，用于机器对机器的通信（与客户端到服务器的传输有点区别）。智能传感器、可穿戴设备和其他物联网（IoT）设备通常必须通过带宽有限的资源受限网络传输和接收数据。这些物联网设备使用 MQTT 进行数据传输，因为它易于实施，并且可以有效地传输物联网数据。MQTT 支持设备到云端和云端到设备之间的消息传递。

## 1.1、特点

1、使用的发布/订阅消息模式，它提供了一对多消息分发，以实现与应用程序的解耦。
2、对负载内容屏蔽的消息传输机制。
3、对传输消息有三种服务质量（QoS）：最多一次，这一级别会发生消息丢失或重复，消息发布依赖于底层TCP/IP网络
   至多一次，这一级别会确保消息到达，但消息可能会重复。
   只有一次，确保消息只有一次到达。在一些要求比较严格的计费系统中，可以使用此级别
4、数据传输和协议交换的最小化（协议头部只有2字节），以减少网络流量
5、通知机制，异常中断时通知传输双方


## 1.2、mqtt协议实现方式

1、实现MQTT协议需要：客户端和服务器端
2、MQTT协议中有三种身份：发布者（Publish）、代理（Broker）（服务器）、订阅者（Subscribe）。其中，消息的发布者和订阅者都是客户端，消息代理是服务器，消息发布者可以同时是订阅者。
3、MQTT传输的消息分为：主题（Topic）和负载（payload）两部分Topic，可以理解为消息的类型，订阅者订阅（Subscribe）后，就会收到该主题的消息内容（payload）
payload，可以理解为消息的内容，是指订阅者具体要使用的内容


# 2、三种服务质量

## 2.1、QoS 0：最多一次传递
在QoS 0级别下，发布者只需将消息发送给MQTT代理，代理会将消息发送给订阅者，但不会保证消息是否到达订阅者。这种级别的实现非常简单，因为不需要进行确认或重传，所以消息传递的延迟和带宽占用都很低

通常选择使用 QoS 0 传输一些高频且不那么重要的数据，比如传感器数据，周期性更新，即使遗漏几个周期的数据也可以接受

## 2.2、QoS 1：最少一次传递
在QoS 1级别下，发布者将消息发送给MQTT代理，代理会将消息发送给订阅者，并等待订阅者的确认。如果代理没有收到确认，它会**重新发送消息，直到收到确认为止**。这种级别的实现需要进行确认和重传，所以消息传递的延迟和带宽占用都比QoS 0高

> QoS1在协议层面上无法避免消息重复的情况，因此在我们的报文内容里面通常加上报文的唯一id，在应用层通过id去对消息去重是最常规的处理方法

## 2.3、QoS 2：恰好一次传递

> MQTT识别报文是通过一个Packet ID来识别是不是重复信息。Qos1收到两条相同Packet ID报文的消息是没办法知道这是重复的信息，还是两条不同的消息只是用的同一个ID的情况，因此Qos1是存在重复消息的问题。QoS2会用更加复杂的交互逻辑来确保消息不会重复

>发送方发送完报文，需要等待收到接收方发送PUBREC报文（在这期间还可以超时重发这个报文），等到收到PUBREC报文后，发送方会继续发送PUBREL （Publish Release）报文，此时不能再重发报文了，并且Packet ID也不能使用。等待收到对端回复的 PUBCOMP 报文后，才表示此时Packet ID被释放完成，可以继续使用Packet ID去发送消息。因此对于接
>
>收方以 PUBREL 报文为界限，凡是在 PUBREL 报文之前到达的 PUBLISH 报文，有相同的Packet ID都必然是重复的消息；而凡是在 PUBREL 报文之后到达的 PUBLISH 报文，有相同的Packet ID都必然是全新的消息。

![image.png](https://yancey-note-img.oss-cn-beijing.aliyuncs.com/202310171035585.png)

在QoS 2级别下，发布者将消息发送给MQTT代理，代理会将消息发送给订阅者，并等待订阅者的确认。如果代理没有收到确认，它会重新发送消息，直到收到确认为止。订阅者收到消息后，会发送确认给代理，代理再将确认发送给发布者。如果代理没有收到确认，它会重新发送消息，直到收到确认为止。这种级别的实现需要进行确认、重传和去重，所以消息传递的延迟和带宽占用都比QoS 1更高。

总的来说，QoS级别越高，消息传递的可靠性越高，但延迟和带宽占用也越高。在选择QoS级别时，需要根据应用场景的需求来进行权衡。

# 3、消息可靠（持久化）
MQTT还有一个持久会话的功能，对应的是Clean Session（清理会话）选项。当Clean Session = 0，以及QoS为1或着2的时候，加入接收端离线了也会在下次在线时收到断连期间的消息。此时的消息会暂存在我们的MQTT服务器端

# 4、mqtt负载均衡
