

# 1、背景

某物联网项目，使用mysql存储数据，但随着接入设备的增加，数据量也呈指数级上升。单表数据超过5000万后，数据库性能急剧下降。这时我们的一般思路就是分库分表，使用mycat，sharding-jdbc等中间件，将大表拆成小表，提升性能。但分库分表的缺点也很明显，比如分表后的操作需要携带分片键，否则还是会扫描到所有的分表，这样导致某些业务场景无法使用到分表提升性能。如果分表跨实例，还会产生分布式事务问题，一旦某个数据库实例宕机，可能出现事务不一致的风险。基于以上的问题，通过调研，我们考虑使用NewSql来解决，而TiDB就是NewSql代表性产品，同时兼容 MySQL 协议和生态，是数据迁移成本最小的方案


|           | 厂商      | 诞生年份 | 优点                                                                            | 缺点                                              |
| --------- | ------- | ---- | ----------------------------------------------------------------------------- | ----------------------------------------------- |
| TDSQL     | 腾讯      | 2004 | 内置分片能力，实现数据的水平扩展                                                              | 只支持传统的 ACID事务                                   |
| OceanBase | 阿里      | 2010 | 高度可扩展性和容错性，支持大规模数据存储和处理，应对高并发工作负载                                             | 部署和管理复杂，学习成本高                                   |
| TiDB      | PingCAP | 2015 | 国内市场占有率高，生态相对完善，一键水平伸缩，强一致性的多副本数据安全，分布式事务，实时 OLAP 等重要特性。同时兼容 MySQL 协议和生态，迁移便捷 | 它对硬件要求较高。目前也分社区版和企业版                            |
| Spanner   | 谷歌      | 2017 | 支持水平扩展和在线分片，可靠的事务处理和高可用性                                                      | Google内部系统，开源和可用性受限，需要与Google Cloud平台集成，可能不方便使用 |


|            | 基本概念                                                               | 实例                           |
| ---------- | ------------------------------------------------------------------ | ---------------------------- |
| RDBMS(Sql) | 关系型数据库，以行列的形式进行存储                                                  | Oracle、MySql、SQL Server      |
| NoSql      | 非关系型数据库，用于超大规模数据的存储。这些类型的数据存储不需要固定的模式，无需多余操作就可以横向扩展                | Redis、Hbase、MongoDB          |
| NewSql     | 目标是将SQL的ACID保证与NoSQL的可扩展性和高性能相结合。可以简单地把NewSQL理解为：在NoSQL基础上，加入了事务能力 | TiDB，OceanBase，TDSQL，Spanner |

# 2、TiDB基本概念

官方文档：https://docs.pingcap.com/zh/

## 2.1、基本概念

TiDB 是 PingCAP 公司的开源分布式关系型数据库，是一款同时支持在线事务处理与在线分析处理 (Hybrid Transactional and Analytical Processing, HTAP) 的融合型分布式数据库产品，具备水平扩容或者缩容、金融级高可用、实时 HTAP、云原生的分布式数据库、兼容 MySQL 5.7 协议和 MySQL 生态等重要特性。目标是为用户提供一站式 OLTP (Online Transactional Processing)、OLAP (Online Analytical Processing)、HTAP 解决方案。TiDB 适合高可用、强一致要求较高、数据规模较大等各种应用场景。

## 2.2、核心特性

1.一键水平扩容或者缩容
得益于 TiDB 存储计算分离的架构的设计，可按需对计算、存储分别进行在线扩容或者缩容，扩容或者缩容过程中对应用运维人员透明。

2.金融级高可用
数据采用多副本存储，数据副本通过 Multi-Raft 协议同步事务日志，多数派写入成功事务才能提交，确保数据强一致性且少数副本发生故障时不影响数据的可用性。可按需配置副本地理位置、副本数量等策略满足不同容灾级别的要求。

3.实时 HTAP
提供行存储引擎 TiKV、列存储引擎 TiFlash 两款存储引擎，TiFlash 通过 Multi-Raft Learner 协议实时从 TiKV 复制数据，确保行存储引擎 TiKV 和列存储引擎 TiFlash 之间的数据强一致。TiKV、TiFlash 可按需部署在不同的机器，解决 HTAP 资源隔离的问题。

4.云原生的分布式数据库
专为云而设计的分布式数据库，通过 TiDB Operator 可在公有云、私有云、混合云中实现部署工具化、自动化。

5.兼容 MySQL 5.7 协议和 MySQL 生态
兼容 MySQL 5.7 协议、MySQL 常用的功能、MySQL 生态，应用无需或者修改少量代码即可从 MySQL 迁移到 TiDB。提供丰富的数据迁移工具帮助应用便捷完成数据迁移。


## 2.3、架构

![image.png|600](https://yancey-note-img.oss-cn-beijing.aliyuncs.com/202403211617902.png)


1、TiDB Server：SQL 层，对外暴露 MySQL 协议的连接 endpoint，负责接受客户端的连接，执行 SQL 解析和优化，最终生成分布式执行计划。TiDB 层本身是无状态的，实践中可以启动多个 TiDB 实例，通过负载均衡组件（如 LVS、HAProxy 或 F5）对外提供统一的接入地址，客户端的连接可以均匀地分摊在多个 TiDB 实例上以达到负载均衡的效果。TiDB Server 本身并不存储数据，只是解析 SQL，将实际的数据读取请求转发给底层的存储节点 TiKV（或 TiFlash）。

2、PD (Placement Driver) Server：整个 TiDB 集群的元信息管理模块，负责存储每个 TiKV 节点实时的数据分布情况和集群的整体拓扑结构，提供 TiDB Dashboard 管控界面，并为分布式事务分配事务 ID。PD 不仅存储元信息，同时还会根据 TiKV 节点实时上报的数据分布状态，下发数据调度命令给具体的 TiKV 节点，可以说是整个集群的“大脑”。此外，PD 本身也是由至少 3 个节点构成，拥有高可用的能力。建议部署奇数个 PD 节点。

3、存储节点
（1）TiKV Server：负责存储数据，从外部看 TiKV 是一个分布式的提供事务的 Key-Value 存储引擎。存储数据的基本单位是 Region，每个 Region 负责存储一个 Key Range（从 StartKey 到 EndKey 的左闭右开区间）的数据，每个 TiKV 节点会负责多个 Region。TiKV 的 API 在 KV 键值对层面提供对分布式事务的原生支持，默认提供了 SI (Snapshot Isolation) 的隔离级别，这也是 TiDB 在 SQL 层面支持分布式事务的核心。TiDB 的 SQL 层做完 SQL 解析后，会将 SQL 的执行计划转换为对 TiKV API 的实际调用。所以，数据都存储在 TiKV 中。另外，TiKV 中的数据都会自动维护多副本（默认为三副本），天然支持高可用和自动故障转移。
（2）TiFlash：TiFlash 是一类特殊的存储节点。和普通 TiKV 节点不一样的是，在 TiFlash 内部，数据是以列式的形式进行存储，主要的功能是为分析型的场景加速。


# 3、TiDB搭建

