

# 0、环境地址信息

## 0.1、vpn

堡垒机地址：https://cbh.chinagasholdings.com/  
VPN:用IE浏览器输入服务器地址：116.31.111.59  
下载SSL VPN客户端
wangfei         U7wo#UUlBk


对接组织架构、数据应该是定时同步、实现单点登录。数据权限，要按照人员角色来划分

# 1、应用系统集成

身份主数据分发（员工、机构、岗位）
开通/回收应用系统账号
单点登录集成


# 2、IMA身份主数据定时同步集成规范

1.身份主数据接口服务
http://172.26.0.137:6011/services/2F06402000001    鉴权账号密码需要应用方自行向SOA申请（Basic Auth的鉴权方式）

（1）人员接口字段（RYXX）
（2）组织（部门）接口字段（ZZJG）
（3）人员组织关系接口字段（RYZZGX）
（4）职务（岗位）接口字段（MDM_RYZW_QUERY）
（5）组织-流程角色（LCJS）


# 3、IAM_OAUTH2单点登录协议集成规范

授权码模式（code - token）
简单模式（暴露token）
密码模式（用户向客户端提供用户名密码）
客户端模式（客户端的密钥，id获取token）

## 3.1、流程
1. 用户访问的系统 → 跳转到IAM认证页（带参数）
2. 用户在IAM页登录 → IAM返回`code`到你的回调地址
3. 系统用`code`换取`access_token`
4. 用`access_token`获取用户信息（如用户名、角色等）
5. 用户成功登录系统


1、接口
IAM系统中注册之后会提供client_id和client_secret
1、请求授权接口：https://认证中心域名/idp/authCenter/authenticate
2、获取授权接口：https://认证中心域名/idp/api/v3/oauth2/token
3、刷新授权接口：https://认证中心域名/idp/api/v3/oauth2/token
4、查询授权接口：https://认证中心域名/idp/api/v3/oauth2/tokenInfo
5、回收授权接口：https://认证中心域名/idp/v3/oauth2/revoke
6、授权接口有效性校验：https://认证中心域名/idp/api/v3/oauth2/introspect
7、获取用户信息接口：https://认证中心域名/idp/api/v3/oauth2/userInfo

2、一人多账号

3、逃生机制集成


# 4、数据同步信息汇总





# 4、问题
1、关于client_id和client_secret的获取，请问具体的申请流程是怎样的？是否需要我们填写正式的申请表单？
2、Token有效期，access_token和refresh_token的默认有效期是多少？是否可以根据应用需求调整
3、获取用户信息接口  -  spRoleList最多也是一个是吧？就是一人多账号的情况下，选了哪个账号，就返回哪个用户名
4、若access_token未超时，那么进行refresh_token不会改变access_token，但超时时间会刷新，相当于续期access_token
5、刷新授权接口，如果若没到token有效期，刷新后token会变吗
6、获取用户信息接口，就是username，怎么去关联用户的详细数据，姓名之类的信息



1、同步组织架构 员工信息  实现单点登录
2、同步人员组织目的 - 离职账号禁用、出报表
3、权限管理（菜单、数据权限）  

李智荣

IAM权限对接要求：
1、同步组织架构、同步员工信息到客服系统。
2、门户增加入口，实现单点登录
主要目的：
1、确保员工离职后，离职状态同步到在线客服系统，禁止登录。
2、同步组织架构-出报表（报表中的组织信息和总部保持一致）。
3、菜单权限控制（角色权限按照“客服系统”规则配置）
4、数据权限控制（角色权限按照“客服系统”规则配置）

 根据上述内容，把IAM接口文档中需要用到的接口信息整理汇总下。
# 5、新问题
1、  人员账号（jianjj）、人员ID（10152813）登录用的是账号吗？是否会重复
1、组织机构和部门的区别
2、部门路径


sequenceDiagram
    participant U as 用户
    participant A as EIP
    participant I as IAM授权服务器

    U->>A: 访问应用首页
    A->>I:  1、请求授权接口，重定向到IAM授权页 <br> (client id, redirect uri, state, response type=code)
    I->>U: 显示登录页
    U->>I: 输入账号密码登录
    I-->>A: 跳转回调地址并返回code
    A->>I: 2、获取授权接口，使用code换取access token<br>(POST /token + Basic Auth)
    I-->>A: 返回access token, refresh token
    A->>I: 3、获取用户信息接口，使用access token获取用户信息 (GET /userlnfo)
    I-->>A: 返回用户信息(username,spRoleList)
    A->>A: 根据spRoleList确定登录身份（存在一人多账号情况）
    A->>U: 登录成功，进入应用