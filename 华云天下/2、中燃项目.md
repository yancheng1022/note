vpn登录信息&堡垒机登录信息&服务器信息  
https://docs.qq.com/sheet/DQm1HTm1SaXphQkxi?no_promotion=1&tab=BB08J2  
  
##### 中燃测试环境  
## 系统登录  
https://testaicc.chinagasholdings.com/#/channelLogin  
企业ID&账号&密码：  
ITGZT \ admin \ WElljoint@210908  
LPG \ admin \ WElljoint@210908  
  
## gls登录账密  
https://testaicc.chinagasholdings.com/gls/login  
HYCC / WElljoint@210908  
  
## nacos  
http://172.25.1.46:8848/nacos  
nacos / hytx@admin!@#  
  
##### 中燃生产环境  
外网https访问：  
地址：https://aicc.chinagasholdings.com/#/channelLogin  
企业ID&账号&密码：  
ITGZT \ admin \ WElljoint@210908  
LPG \ admin \ WElljoint@210908  
外网内网http访问：  
地址：http://aicc.chinagasholdings.com/#/channelLogin  
企业ID&账号&密码：  
ITGZT \ admin \ WElljoint@210908  
LPG \ admin \ WElljoint@210908  
内网ip访问：  
地址：http://172.25.1.68/#/channelLogin  
企业ID&账号&密码：  
ITGZT \ admin \ WElljoint@210908  
LPG \ admin \ WElljoint@210908  
  
## gls登录账密  
https://aicc.chinagasholdings.com/gls  
HYCC / WElljoint@210908  
  
## nacos  
http://172.25.1.65:8848/nacos  
nacos / hytx@admin!@#

# 0、环境地址信息

## 0.1、vpn

VPN:用IE浏览器输入服务器地址：116.31.111.59  
下载SSL VPN客户端
wf/Gas#*20200858

## 0.2、SOA账密
"智能呼叫中心系统"SOA测试环境使用账号/密码：  
     账号：OSB_DEV_AICC  
     密码：AiccWx2#86  
 "智能呼叫中心系统"SOA正式环境使用账号/密码：  
     账号：OSB_PRD_AICC  
     密码：AiccPrdSq9#86  
请注意信息安全，保管好账号密码

## 0.3、同步接口
|               |                                                                                                                                                         |
| ------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------- |
| SOA服务地址（测试环境） | [http://172.26.0.137:6011/services/2F06402000001](http://172.26.0.137:6011/services/2F06402000001)<br><br>_鉴权账号密码需要应用方自行向SOA申请_                         |
| SOA服务地址（生产环境） | [http://soa.chinagasholdings.com:7011/services/2F06402000001](http://soa.chinagasholdings.com:7011/services/2F06402000001)<br><br>_鉴权账号密码需要应用方自行向SOA申请_ |

## 0.4、堡垒机
堡垒机地址：https://cbh.chinagasholdings.com/  
yanshaowei  
c@ZSdqycB#1

172.25.1.47  数据库 ，  在主机上输入以下命令   connect db      就能进数据库命令行 hycca_3.0
42主机  应用服务器


## 0.5、租户
KFZX
LPG
ITGZT（IT工作台）

## 0.6、测试环境
https://testaicc.chinagasholdings.com/#/channelLogin
KFZX/8002/2wsx@WSX
KFZX/guoyc/c@ZSdqycB#1

登录VPN后访问http://172.25.1.46:8848/nacos  
账号：nacos  
密码：hytx@admin!@#


# 1、应用系统集成

身份主数据分发（员工、机构、岗位）
开通/回收应用系统账号
单点登录集成


# 2、IMA身份主数据定时同步集成规范

1.身份主数据接口服务
http://172.26.0.137:6011/services/2F06402000001    鉴权账号密码需要应用方自行向SOA申请（Basic Auth的鉴权方式）

（1）人员接口字段（RYXX）
（2）组织（部门）接口字段（ZZJG）
（3）人员组织关系接口字段（RYZZGX）
（4）职务（岗位）接口字段（MDM_RYZW_QUERY）
（5）组织-流程角色（LCJS）


# 3、IAM_OAUTH2单点登录协议集成规范

授权码模式（code - token）
简单模式（暴露token）
密码模式（用户向客户端提供用户名密码）
客户端模式（客户端的密钥，id获取token）

## 3.1、流程
1. 用户访问的系统 → 跳转到IAM认证页（带参数）
2. 用户在IAM页登录 → IAM返回`code`到你的回调地址
3. 系统用`code`换取`access_token`
4. 用`access_token`获取用户信息（如用户名、角色等）
5. 用户成功登录系统


1、接口
IAM系统中注册之后会提供client_id和client_secret
1、请求授权接口：https://认证中心域名/idp/authCenter/authenticate
2、获取授权接口：https://认证中心域名/idp/api/v3/oauth2/token
3、刷新授权接口：https://认证中心域名/idp/api/v3/oauth2/token
4、查询授权接口：https://认证中心域名/idp/api/v3/oauth2/tokenInfo
5、回收授权接口：https://认证中心域名/idp/v3/oauth2/revoke
6、授权接口有效性校验：https://认证中心域名/idp/api/v3/oauth2/introspect
7、获取用户信息接口：https://认证中心域名/idp/api/v3/oauth2/userInfo

2、一人多账号

3、逃生机制集成


# 4、数据同步信息汇总





# 4、问题


李智荣
1、关于接口调用方式： 各接口抽取数据时，需先进行首次调用访问。首次调用访问时批次号和历史批次号传空，startTime和endTime传时间日期，访问之后IAM会返回两个批次号（批次号和历史批次号）和一个totalCount(总页数)，后续访问传IAM给出的批次号、历史批次号、信息，遍历按照总页数去遍历循环每一页数据，从第一页开始（pageNumber=0是第一页），循环取出数据。

只有第一次全量同步的时候批次号和历史批次号传空吗？ 
全量访问开始时间传什么？
后续传批次号和历史批次号，是用第一次返回的，还是上次返回的？

2、人员离职通过哪个字段判断？数据更新修改删除都会增量同步吗


1、怎么发包
2、测试地址
3、查看库表

# 5、开发

## 5.1、表结构

CREATE TABLE iam_sync_batch (
    id int(11) AUTO_INCREMENT PRIMARY KEY,
    sync_type VARCHAR(32) NOT NULL COMMENT '同步类型: RYXX(人员), ZZJG（组织）, RYZZGX（人员-组织）, MDM_RYZW_QUERY（职务）,LCJS（角色）',
    batch VARCHAR(200) NOT NULL COMMENT '当前批次号',
    batch_history VARCHAR(200) NOT NULL COMMENT '历史批次号',
    total_count INT DEFAULT 0 COMMENT '总记录数',
    sync_status TINYINT DEFAULT 0 COMMENT '状态: 0-同步中, 1-同步成功, 2-同步失败',
    start_time varchar(32)  COMMENT '开始时间',
    end_time varchar(32) COMMENT'结束时间',
    created_time varchar(32) COMMENT '创建时间',
    updated_time varchar(32) COMMENT '更新时间'
) ENGINE=InnoDB DEFAULT CHARSET=utf8 ROW_FORMAT=DYNAMIC COMMENT 'IAM同步批次信息表';


加密请求： {"applicationCode":"AICC","batch":"","batchHistory":"","endTime":"2025/10/29 13:33:01","ifaceCode":"RYXX","pageNumber":0,"startTime":"1900/10/27 00:00:00"}

完整请求：{"applicationCode":"AICC","auth":"AICC","batch":"","ifaceCode":"RYXX","requestData":"eyJhcHBsaWNhdGlvbkNvZGUiOiJBSUNDIiwiaWZhY2VDb2RlIjoiUllYWCIsInN0YXJ0VGltZSI6IjIwMTUtMTAtMjcgMDA6MDA6MDAiLCJlbmRUaW1lIjoiMjAyNS0xMC0yOSAxMzozMzowMSIsImJhdGNoIjoiIiwiYmF0Y2hIaXN0b3J5IjoiIiwicGFnZU51bWJlciI6MCwicGFnZVNpemUiOjEwMDAsImRlcHRJZCI6bnVsbCwiZW1wSWQiOm51bGwsIm9yZ0NvZGUiOm51bGwsInBhcmVudERlcElkIjpudWxsLCJsYXN0dXBkYXRlZHRpbWUiOm51bGx9"}


# 6、上线

## 6.1、短信
### 6.1.1、sql

```sql
INSERT INTO `hycca_3.0`.`sms_entid_gateway` (`entId`, `company_name`, `gateway_id`, `is_default`)
VALUES
('ITGZT', 'IT工作台', 111, 0);

INSERT INTO `hycca_3.0`.`sms_gateway_config` (`sms_company`, `send_type`, `url`, `data`) VALUES ('中燃-孝感', 'SendMessageZRQServiceImpl', 'https://cjdsm.chinagasholdings.com/api/open-api/v2/text/task/create', '{\"accesskey\":\"c2k26U8XBSly7hh4BZdzXXjk1wkGKMgQ\",\"secret\":\"Ptsty0BPsjJckwQOyW2eOJP0W85EQYRDfpsJ6SSHvBXGB6AhKNplXmD4gLM7Q5KY\",\"groupCount\":\"100\"}');

INSERT INTO `hycca_3.0`.`sms_gateway_config` (`sms_company`, `send_type`, `url`, `data`) VALUES ( '中燃-芜湖', 'SendMessageZRQServiceImpl', 'https://cjdsm.chinagasholdings.com/api/open-api/v2/text/task/create', '{\"accesskey\":\"I0XDZ9XKEyNALYkYXMluzbsiO4YTbFSx\",\"secret\":\"oa3rf75uYFm9Kh5m8UxK6O492Na6QHhNo6GJGIaIYya1Gstws2quiJtkCcARO5Gb\",\"groupCount\":\"100\"}');

INSERT INTO `hycca_3.0`.`sms_entid_gateway` (`entId`, `company_name`, `gateway_id`, `is_default`)
VALUES
('ITGZT', 'IT工作台', 111, 0);
```
【中国燃气】您的短信验证码为:1234，该验证码在1分钟内有效，请您尽快完成操作（中燃集团–举报中心）
### 6.1.2、网关参数

```sql
-- 孝感
{"accesskey":"c2k26U8XBSly7hh4BZdzXXjk1wkGKMgQ","secret":"Ptsty0BPsjJckwQOyW2eOJP0W85EQYRDfpsJ6SSHvBXGB6AhKNplXmD4gLM7Q5KY"}
-- 芜湖
{"accesskey":"MfvnTfhyKIgggT6eRfCj6VXGs2aZPIYV","secret":"OcaHWZbrBu3tPbX3TvqNHuMCMNFJkuY6iEI4B4QfmjLLInjpyyKwldFRKk5ZVXgr"}
```
## 6.2、组织架构同步
### 6.2.1、sql
```sql
CREATE TABLE `iam_sync_batch` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `sync_status` tinyint(4) DEFAULT '0' COMMENT '状态: 0-同步成功, 1-同步失败',
  `start_time` datetime DEFAULT NULL COMMENT '开始时间',
  `end_time` datetime DEFAULT NULL COMMENT '结束时间',
  `created_time` datetime DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_time` datetime DEFAULT NULL COMMENT '更新时间',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 ROW_FORMAT=DYNAMIC COMMENT='IAM同步批次信息表';

CREATE TABLE `iam_sys_dept` (
  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT '部门编号',
  `dept_id` varchar(100) NOT NULL COMMENT 'iam部门编号',
  `dept_pid` varchar(100) NOT NULL COMMENT 'iam父部门编号',
  `dept_name` varchar(32) NOT NULL COMMENT 'iam部门名称',
  `status` tinyint(1) unsigned DEFAULT '0' COMMENT '部门状态 默认0（0-启用 1-停用）',
  `company_id` varchar(32) DEFAULT NULL COMMENT '公司id',
  `company_name` varchar(32) DEFAULT NULL COMMENT '公司名称',
  `create_time` datetime DEFAULT NULL COMMENT '创建时间',
  `update_time` datetime DEFAULT NULL COMMENT '更新时间',
  PRIMARY KEY (`id`) USING BTREE,
  UNIQUE KEY `idx_dept_id_unique` (`dept_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE `iam_sys_user` (
  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT '用户编号',
  `iam_empid` varchar(100) DEFAULT NULL COMMENT 'IAM人员账号',
  `iam_empname` varchar(100) DEFAULT NULL COMMENT 'IAM人员名称',
  `iam_deptid` varchar(100) DEFAULT NULL COMMENT 'IAM部门id',
  `iam_depname` varchar(100) DEFAULT NULL COMMENT 'IAM部门名称',
  `iam_dept_parent` varchar(100) DEFAULT NULL COMMENT 'IAM父组织机构ID',
  `iam_rolename` varchar(100) DEFAULT NULL COMMENT 'IAM角色编码',
  `iam_roledescr` varchar(100) DEFAULT NULL COMMENT 'IAM角色描述',
  `entid` varchar(100) DEFAULT NULL COMMENT '租户id',
  `status` varchar(10) DEFAULT '0' COMMENT '状态（0-启用，1-停用）',
  `create_time` datetime DEFAULT NULL COMMENT '创建时间',
  `update_time` datetime DEFAULT NULL COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_iam_empid_unique` (`iam_empid`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
```

### 6.2.2、nacos配置
```txt
iam:
  sync:
    cron: 0 */30 * * * ?
    applicationCode: AICC
    soaUrl: http://soa.chinagasholdings.com:7011/services/2F06402000001
    authUserName: OSB_PRD_AICC
    authPassword: AiccPrdSq9#86
    defaultPassword: Zr@123456
    defaultRoleId: 1
```


完成中燃租户分配、 短信网关对接功能、然后把扫描出来的严重漏洞改完了
先和前端联调一下租户分配功能（1天）中燃代码扫描还有十几个安全漏洞需要改一下（1天）

城燃行政组织架构：
集团  01
区域管理中心02
东北区域经营管理中心 03
经管中心 07
项目公司 04
- 分子公司（本质上也是项目公司）05
- 网格 06

燃气用户与组织管理：
org no：用户管理组织（360视图：所属网格/组织）
prj prg no：管理组织（360视图：项目公司）


# 7 、更新

docker cp hy-shortmessage:/app/hy-shortmessage.jar /data/crm01/yc/back/

cd /data/crm01/yc

docker cp crm-system.jar crm-system:/app/